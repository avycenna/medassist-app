generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                     String                  @id @default(cuid())
  email                  String                  @unique
  username               String?                 @unique
  passwordHash           String
  name                   String
  role                   Role
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  assignedCases          Case[]                  @relation("AssignedProvider")
  receivedDirectMessages DirectMessage[]         @relation("ReceivedMessages")
  sentDirectMessages     DirectMessage[]         @relation("SentMessages")
  messages               Message[]               @relation("UserMessages")
  readMessages           MessageRead[]
  notificationPreference NotificationPreference?
  sessions               Session[]

  @@index([email])
  @@index([role])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model Case {
  id                   String          @id @default(cuid())
  patientName          String?
  firstName            String?
  lastName             String?
  dob                  DateTime?
  address              String?
  phoneNumber          String?
  email                String?
  nationality          String?
  assistanceType       AssistanceType?
  referenceNumber      String?
  availability         String?
  status               CaseStatus      @default(PENDING)
  assignedToId         String?
  source               String          @default("EMAIL")
  rawEmailContent      String?
  emailSubject         String?
  emailFrom            String?
  emailReceivedAt      DateTime?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  archivedAt           DateTime?
  deletedAt            DateTime?
  isArchived           Boolean         @default(false)
  approvedStatus       Int?
  assignedToAssistance String?
  canCancelVoucher     String?
  clientName           String?
  codeAssist           String?
  codigo               String?
  descAssistanceType   String?
  idAssist             Int?
  idAssistanceType     Int?
  idUsersCreated       Int?
  isoCountry           String?
  isoCountrySource     String?
  origin               String?
  passport             String?
  prefijo              String?
  refund               String?
  registeredDate       DateTime?
  reportedDate         DateTime?
  specialityLocation   String?
  statusAssistIcon     String?
  statusAssistLabel    String?
  statusAssistStatus   String?
  symptom              String?
  symptomDetail        String?
  triageColor          String?
  triageLabel          String?
  triageStatus         String?
  view                 String?
  voucherIsManual      String?
  assignedTo           User?           @relation("AssignedProvider", fields: [assignedToId], references: [id])
  magicLinks           MagicLink[]
  messages             Message[]
  statusHistory        StatusHistory[]

  @@index([status])
  @@index([assignedToId])
  @@index([createdAt])
  @@index([isArchived])
  @@index([deletedAt])
  @@index([idAssist])
  @@index([codeAssist])
}

model MagicLink {
  id              String    @id @default(cuid())
  tokenHash       String    @unique
  caseId          String
  clientFirstName String?
  clientLastName  String?
  clientEmail     String?
  clientPhone     String?
  intakeCompleted Boolean   @default(false)
  expiresAt       DateTime?
  revokedAt       DateTime?
  usedAt          DateTime?
  createdAt       DateTime  @default(now())
  case            Case      @relation(fields: [caseId], references: [id], onDelete: Cascade)
  messages        Message[]

  @@index([tokenHash])
  @@index([caseId])
}

model Message {
  id          String        @id @default(cuid())
  caseId      String
  content     String
  senderType  SenderType
  senderId    String?
  magicLinkId String?
  createdAt   DateTime      @default(now())
  case        Case          @relation(fields: [caseId], references: [id], onDelete: Cascade)
  magicLink   MagicLink?    @relation(fields: [magicLinkId], references: [id])
  sender      User?         @relation("UserMessages", fields: [senderId], references: [id])
  readBy      MessageRead[]

  @@index([caseId])
  @@index([createdAt])
}

model MessageRead {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([userId])
  @@index([messageId])
}

model NotificationPreference {
  id               String   @id @default(cuid())
  userId           String   @unique
  pushEnabled      Boolean  @default(true)
  emailEnabled     Boolean  @default(true)
  pushSubscription String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model StatusHistory {
  id         String      @id @default(cuid())
  caseId     String
  fromStatus CaseStatus?
  toStatus   CaseStatus
  changedBy  String?
  note       String?
  createdAt  DateTime    @default(now())
  case       Case        @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
}

model ProcessedEmail {
  id         String   @id @default(cuid())
  messageId  String   @unique
  subject    String?
  from       String?
  receivedAt DateTime
  processed  Boolean  @default(false)
  caseId     String?
  error      String?
  createdAt  DateTime @default(now())

  @@index([messageId])
}

model EmailSettings {
  id              String    @id @default(cuid())
  isActive        Boolean   @default(true)
  lastChecked     DateTime?
  checkInterval   Int       @default(60)
  messagesToCheck Int       @default(50)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model DirectMessage {
  id         String   @id @default(cuid())
  content    String
  senderId   String
  receiverId String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  sender     User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
}

model Campaign {
  id                String              @id
  name              String
  subject           String
  body              String
  status            CampaignStatus      @default(DRAFT)
  smtpProviderId    String
  scheduledAt       DateTime?
  sentAt            DateTime?
  totalRecipients   Int                 @default(0)
  sentCount         Int                 @default(0)
  failedCount       Int                 @default(0)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  SmtpProvider      SmtpProvider        @relation(fields: [smtpProviderId], references: [id])
  CampaignRecipient CampaignRecipient[]

  @@index([smtpProviderId])
  @@index([status])
}

model CampaignRecipient {
  id         String    @id
  campaignId String
  email      String
  name       String?
  sent       Boolean   @default(false)
  sentAt     DateTime?
  failed     Boolean   @default(false)
  error      String?
  createdAt  DateTime  @default(now())
  Campaign   Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([email])
}

model SmtpProvider {
  id         String     @id
  name       String
  host       String
  port       Int
  username   String
  password   String
  fromEmail  String
  fromName   String?
  useTLS     Boolean    @default(true)
  isActive   Boolean    @default(true)
  isBulk     Boolean    @default(false)
  lastTested DateTime?
  testStatus String?
  testError  String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime
  Campaign   Campaign[]

  @@index([isActive])
  @@index([isBulk])
}

enum Role {
  OWNER
  PROVIDER
}

enum CaseStatus {
  PENDING
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum AssistanceType {
  TELECONSULTATION
  CLINIC_CONSULT
  HOME_VISIT
  EMERGENCY
  OTHER
}

enum SenderType {
  OWNER
  PROVIDER
  CLIENT
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
}
